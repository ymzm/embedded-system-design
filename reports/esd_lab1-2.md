# <center>嵌入式系统设计</center>
# <center>实验报告 </center>

## 1.实验名称
嵌入式开发环境构建
## 2.实验学时
4学时
## 3.实验内容和目的
### 3.1 实验内容
1、 嵌入式Linux主机开发环境搭建；
2、 嵌入式Linux主机调试环境搭建；
3、 交叉开发环境搭建；
4、 GCC编译测试;
5、 SD卡启动盘制作、调试串口工具、烧写uboot；
6、 NFS挂载方式启动并执行交叉编译的可执行文件；
### 3.2 实验目的
1、熟悉嵌入式Linux主机开发环境的搭建，熟悉VMware Player虚拟机软件的安装以及Linux操作系统的安装配置；
2、熟悉嵌入式Linux主机调试环境搭建，主要包括Linux系统下如何配置TFTP服务以及NFS服务；
3、熟悉交叉编译环境的搭建，主要包括开发环境网络的配置，开发板的连接与启动，如何设置串口调试工具，如何烧写U-boot，以及开发板的几种启动方式的配置。
4、熟悉GCC编译器编译C程序的方法，熟悉GCC编译器编译程序的各个阶段。
5、熟悉串口工具
6、熟悉uboot
7、熟悉nfs
## 4.实验原理
1、华清远见开发环境是基于Ubuntu 12.04 LTS 64-bit操作系统搭建的，使用VMware Player作为虚拟机工作软件。
2、TFTP 协议是简单文件传输协议，基于UDP协议，没有文件管理、用户控制功能。TFTP分为服务器端程序和客户端程序，在主机上通常同时配置有TFTP服务器和客户端。
3、NFS方式是开发板通过NFS挂载放在主机（PC）上的根文件系统。此时在主机的文件系统中进行的操作同步反映在开发板上；反之，在开发板上的操作同步反映在主机中的文件系统上。实际工作中，我们经常使用NFS方式进行系统挂载，这种方式对系统的调试非常的方便。
4、使用TFTP方式下载内核到开发板上；使用NFS方式挂载文件系统。
5、GNU CC（简称为gcc）是GNU 项目中符合ANSI C 标准的编译系统，可以编译如C、C++、Object C、Java、Fortran、Pascal、Modula-3 和Ada 等多种语言，而且gcc 又是一个交叉平台编译器，它能够在当前CPU 平台上为多种不同体系结构的硬件平台开发软件，因此尤其适合在嵌入式领域的开发编译。
## 5.实验步骤
### 5.1 vmware虚拟机安装与配置
1.按照实验指导书上步骤安装VMware Player
2.按照实验指导书上步骤使用VMware Player安装Ubuntu 12.04 LTS 64-bit虚拟机，配置情况为：内存2G、处理器4个内核、硬盘80G、网络适配器为桥接模式等等

### 5.2 嵌入式Linux主机调试环境搭建
#### 5.2.1 测试tftp
#### 5.2.2 linux系统配置NFS
```
    $ sudo vi /etc/exports
```
NFS 允许挂载的目录及权限在文件/etc/exports 中进行了定义。我们要将/source/rootfs 目录共享出来，在/etc/exports 文件末尾添加如下一行： 
```
    ...
    /source/rootfs *(rw,sync,no_root_squash,no_subtree_check)
```
保存并退出：
```
    :wq
```
其中：/source/rootfs 是要共享的目录，*代表允许所有的网络段访问，rw 是可读写权限,sync 是资料同步写入内存和硬盘，no_root_squash 是NFS 客户端分享目录使用者的权限，如果客户端使用的是root 用户，那么对于该共享目录而言，该客户端就具有root 权限。

重启服务：
```
    $ sudo /etc/init.d/nfs-kernel-server restart
```
### 5.3 交叉开发环境搭建

#### 5.3.1 设置虚拟机IP
4.1 虚拟机网络方式为桥接模式，此状态下虚拟机下的操作系统和主机操作系统为平级状态。为了调试方便，我们可以给虚拟机下的Ubuntu一个静态的IP地址。
我们使用的网络地址为192.168.100.x 段的，可以给Ubuntu 分配一个IP 为192.168.100.192， 配置过程如下所示。
配置虚拟机网络环境。
```
    $ sudo vim /etc/network/interfaces 
```
修改文件为下并保存退出。
```
    auto lo
    iface lo inet loopback
    
    auto eth0
    iface eth0 inet static
    address 192.168.100.192
    netmask 255.255.255.0
    gateway 192.168.100.1
    network 192.168.100.0
    broadcast 192.168.100.255
    dns-nameservers 192.168.100.1
```
重启服务
```
    $ sudo /etc/init.d/networking restart
```
使用ifconfig命令：
```
    $ ifconfig
```
查看修改的结果
```
    ...
    inet 地址:192.168.100.192 ...
    ...
```
修改成功。
 
#### 5.3.2  配置交叉工具链
开发环境包含了 3 个版本的交叉工具链，路径在/usr/local/toolchain/下，不必再次解压，直接指向路径即可。
一般情况下，当我们输入一个Linux 命令，比如【ls】可以直接执行功能，但我当前的目录并没有【ls】这个文件。【ls】这个命令文件在【/bin】这个目录中，我们可以执行这是因为这些命令所在的路径包含在了用户的环境变量中。
回到当前用户家目录，然后输入指令
```
    $ vi .bashrc
```

在文件末尾添加下一行，地址为交叉工具链的绝对存放路径
```
    ...
    export PATH=$PATH:/usr/local/toolchain/toolchain-4.6.4/bin/
```
重启配置文件
```
    $ source ~/.bashrc
```
工具链的测试
```
    $ arm-none-linux-gnueabi-gcc -v
```
得到arm-none-linux-gnueabi-gcc的版本信息，配置正确。

### 5.4 GCC编译测试
#### 5.4.1 建立相关目录
```
    $ mkdir app
    $ cd app
```

#### 5.4.2 编辑helloworld代码
```
    $ vi helloworld.c
```
#### 5.4.3 使用交叉工具链armgcc静态编译helloworld.c文件并使用file命令查看文件类型
```
    $ arm-none-linux-gnueabi-gcc helloworld.c  -o arm_helloworld -static
    $ file arm_helloworld
```
### 5.5 启动开发板并执行交叉编译的目标文件
#### 5.5.1 制作SD卡启动盘并烧写uboot (可选)
根据指导手册说明进行操作，使用脚本制作2010版本uboot的启动盘，并将2013版本uboot拷贝到SD卡上指定目录。
启动开发板，串口工具，波特率设为115200。
使用使用2010版本uboot的命令
```
    # sdufuse flashall
```
将2013版本uboot烧写至flash。
#### 5.5.2 NFS挂载方式启动并执行可执行文件
烧写uboot
```
    # tftp 40008000 u-boot-fs4412.bin
    # movi write u-boot 40008000
```
按照实验指导书修改开发板环境变量（tftp serverip,开发板ip, 网关ip，启动命令， 启动参数）并保存。
```
    # setenv serverip 192.168.100.192
    # setenv ipaddr 192.168.100.122
    # setenv bootcmd tftp 41000000 uImage\;tftp 42000000 exynos4412-fs4412.dtb\;bootm 41000000 – 42000000
    # setenv bootargs root=/dev/nfs nfsroot=192.168.100.192:/source/rootfs rw console=ttySAC2,115200 init=/linuxrc ip=192.168.100.122
    # saveenv
```
重启开发板，将可执行文件拷贝至开发板
```
    $ cp arm_helloworld /source/rootfs
```
在开发板的串口输入如下命令并得到预期结果，实验完成。
```
    $ cd /
    $ ./arm_helloworld
    hello world!!!
```
## 6.实验结果及分析
1.桥接模式
桥接网络是指本地物理网卡和虚拟网卡通过VM虚拟交换机进行桥接，物理网卡和虚拟网卡在拓扑图上处于同等地位，也就是说物理网卡和虚拟网卡就相当于处于同一个网段，虚拟交换机就相当于一台现实网络中的交换机,所以两个网卡的IP地址也要设置为同一网段。
当我们要在局域网使用虚拟机，对局域网其他pc提供服务时，例如提供ftp，提供ssh、提供http服务，那么就要选择桥接模式。
2.Linux下的tftp协议
TFTP是一个传输文件的简单协议，它基于UDP协议而实现，但也不能确定有些TFTP协议是基于其它传输协议完成的。此协议设计的时候是进行小文件传输的。因此它不具备通常的FTP的许多功能，它只能从文件服务器上获得或写入文件，不能列出目录，不进行认证，它传输8位数据。传输中有三种模式：netascii，这是8位的ASCII码形式，另一种是octet，这是8位源数据类型；最后一种mail已经不再支持，它将返回的数据直接返回给用户而不是保存为文件。
3.交叉开发环境中的交叉编译工具链
通常构建交叉工具链有如下三种方法：
方法一 分步编译和安装交叉编译工具链所需要的库和源代码，最终生成交叉编译工具链。该方法相对比较困难，适合想深入学习构建交叉工具链的读者。如果只是想使用交叉工具链，建议使用下列的方法二构建交叉工具链。
方法二 通过Crosstool脚本工具来实现一次编译，生成交叉编译工具链，该方法相对于方法一要简单许多，并且出错的机会也非常少，建议大多数情况下使用该方法构建交叉编译工具链。
方法三 直接通过网上下载已经制作好的交叉编译工具链。该方法的优点不用多说，当然是简单省事，但该方法有一定的弊端就是局限性太大，因为毕竟是别人构建好的，也就是固定的，没有灵活性，所以构建所用的库以及编译器的版本也许并不适合你要编译的程序，同时也许会在使用时出现许多莫名其妙的错误。
## 7.实验结论、问题及改进建议
### 7.1 结论
回顾本次实验，学会了使用虚拟机安装Linux系统以及熟悉了一些基本的Linux命令，可以进行简单的Linux操作了。实现了交叉工具链的搭建，为后面的开发板上的开发打下了一个坚实的基础，希望在后面的学习实验中，再接再厉。
### 7.2 问题及解决方法
总而言之，指导老师与实验指导书讲解详细透彻，小组成员交流分享，实验过程很顺利。但是也遇到若干问题，如下所述。
#### 7.2.1. 串口调试时无输出
#####问题
连接开发板并正确设置波特率等参数，开发板上电后始终无法看到串口打印。
#####解决方法
分析问题，可能原因有很多。
1 串口始终没有进行打印
开发板上电之后会执行uboot的代码，这些代码有打印。反复重启串口仍然没有输出，如果开发板未损坏且uboot代码被执行的话应排除此情况。暂时跳过此情况。
2 串口选择不正确
经过查看确认，串口工具中选择的串口正确。此情况排除。
3 串口设置不正确
经过查看确认，串口设置正确。此情况排除。
4 串口线损坏
有可能是这个原因，需要更换串口线尝试。暂时跳过此情况。
5 串口接触不良
李春杰老师提示串口线比较短，所以有可能跟PC机接触不良。移动PC机并重新插紧串口，看到串口打印，问题解决。

### 7.2.2 如何将虚拟机中编译的可执行文件拷贝到开发板上执行
##### 问题
不知道采用什么方法将交叉编译环境生成的可执行文件拷贝到开发板上并运行。
##### 解决方法
分析问题，开发板运行的是Linux操作系统，可以使用scp、ftp、U盘等多种方式将可执行文件拷贝到开发板上。
    但是开发板暂时没有连接网络，也不知道开发板上所运行系统是否已安装这些工具或驱动。经老师提示并仔细查看实验指导手册，发现开发板已通过NFS将自己的根目录挂载到了虚拟机的某目录，使用cp命令就可以将文件拷贝过去。
    Linux与开发板文件共享机制：这两者之间是通过NFS这一文件系统来实现文件的共享的。NFS的主要功能是通过网络让不同的机器系统之间可以彼此共享文件和目录。NFS服务器可以允许NFS客户端将远端NFS服务器端的共享目录挂载到本地的NFS客户端中。在本地的NFS客户端的机器看来，NFS服务器端共享的目录就好像自己的磁盘分区和目录一样。通过网络共享目录，让网络上的其他服务器能够挂载访问共享目录内的数据。通俗的来讲，通过NFS将Linux主机设置成为一个NFS服务端，而开发板则成为NFS客户端，通过设置可以读写Linux主机中的固定文件。
    
## 小组成员
howif
dzw
dh

